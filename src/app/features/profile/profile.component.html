<app-header headerText="My Profile" [pageType]="pageTypes.PROFILE"></app-header>

<div class="profile-section">
  @if (profileService.loadingProfile) {
  <div class="flex justify-content-center align-items-center gap-20px">
    <strong> Loading Profile ... </strong>
    <mat-spinner color="h-35px w-35px"></mat-spinner>
  </div>
  } @else {
  <!-- Cover photo section with Profile photo -->
  <div
    class="cover-photo-section"
    [ngStyle]="{
      'background-image': 'url(' + profileService.profile.coverPhotoURL + ')'
    }"
  >
    @if (!profileService.profile.coverPhotoURL) {
    <div class="options">
      <app-cover-photo-upload-options
        [profile]="profileService.profile"
        [option]="pictureOptions.COVER_PHOTO"
      ></app-cover-photo-upload-options>
    </div>
    }
  </div>

  <div>
    @if (profileService.profile.photoURL) {
    <div
      class="profile-photo"
      [ngStyle]="{
        'background-image': 'url(' + profileService.profile.photoURL + ')'
      }"
      [class.disabled]="profileService.updatingProfileImage"
    >
      @if (profileService.isMyProfile) { @if
      (profileService.updatingProfileImage) {
      <mat-spinner color="accent" class="h-25px w-25px"></mat-spinner>
      } @else {
      <div class="actions">
        <mat-icon matTooltip="View" (click)="viewProfilePhoto()"
          >visibility</mat-icon
        >

        <mat-icon matTooltip="Update" [matMenuTriggerFor]="pictureUpdateMenu"
          >edit</mat-icon
        >
        <mat-menu #pictureUpdateMenu="matMenu" class="picture-update-menu">
          <label mat-menu-item class="picture-input-label" for="picture-input"
            >Upload from a Computer</label
          >
          <input
            type="file"
            hidden="true"
            id="picture-input"
            accept="image/*"
            (change)="
              profileService.onPictureChange(
                $event,
                profileService.profile,
                '',
                true
              )
            "
          />
          <button mat-menu-item (click)="openWebcamDialog()">
            Take a photo
          </button>
        </mat-menu>

        <mat-icon
          matTooltip="Remove"
          (click)="openConfirmPictureDeletionDialog()"
          >delete</mat-icon
        >
      </div>
      } }
    </div>
    } @else { @if (profileService.isMyProfile) {
    <!--  <app-profile-picture-upload-options
      [profile]="profileService.profile"
      [option]="pictureOptions.PROFILE_PHOTO"
    ></app-profile-picture-upload-options> -->
    } @else { } }
  </div>

  <div>
    <div>
      <strong> Username </strong>
    </div>
    <div>
      {{ profileService.profile.displayName }}
    </div>
  </div>

  <div>
    <div>
      <strong> Email Address </strong>
    </div>
    <div>
      {{ profileService.profile.email }} @if
      (profileService.profile.isEmailVerified) {
      <span> (Verified) </span>
      }
    </div>
    @if (!profileService.profile.isEmailVerified && profileService.isMyProfile)
    {
    <div class="mt-5px">
      Your email is not verified yet.
      <div class="mt-10px">
        <button
          mat-flat-button
          color="primary"
          class="h-30px w-115px text-center"
          (click)="authService.sendEmailVerification()"
          [disabled]="authService.sendingEmail"
        >
          @if (authService.sendingEmail) {
          <mat-spinner class="ml-10px h-20px w-20px"></mat-spinner>
          } @else { Verify now }
        </button>
      </div>
    </div>
    }
  </div>

  <div>
    <div>
      <strong> Gender </strong>
    </div>
    <div>
      {{ profileService.profile.genderId == 1 ? "Male" : "Female" }}
    </div>
  </div>

  <div>
    <div [class.mb-8px]="profileService.isMyProfile">
      <strong> Birthday </strong>
    </div>

    @if (profileService.profile.dob && !profileService.isEditable.birthday) {
    <div class="flex align-items-center gap-10px">
      <span>
        {{ profileService.profile.dob | date : "MMMM d, y" }}
      </span>

      @if (!profileService.isEditable.birthday && profileService.isMyProfile) {
      <mat-icon
        class="pointer"
        (click)="profileService.prepareBirthdayForm()"
        [class.disabled-icon]="
          profileService.isEditable.birthday ||
          profileService.isEditable.privacy
        "
        >edit</mat-icon
      >
      }
    </div>
    } @else { @if (!profileService.profile.dob && profileService.isMyProfile) {
    <div>You haven't updated your birthday.</div>
    <div class="mt-10px mb-25px">
      <button
        mat-flat-button
        class="h-30px"
        color="primary"
        (click)="profileService.prepareBirthdayForm()"
      >
        Click
      </button>
      to update.
    </div>
    } @if (profileService.isEditable.birthday && profileService.isMyProfile) {
    <div
      class="flex justify-content-center align-items-center mt-10px gap-20px"
    >
      <app-datepicker [field]="profileService.field"></app-datepicker>
      <div class="close-icon">
        <mat-icon
          size="small"
          class="pointer"
          (click)="profileService.isEditable.birthday = false"
          >close</mat-icon
        >
      </div>
    </div>
    } @else {
    <mat-icon
      class="pointer"
      (click)="profileService.isEditable.birthday = false"
      >close</mat-icon
    >
    } }
  </div>

  <div>
    <div [class.mb-8px]="profileService.isMyProfile">
      <strong> Profile Privacy </strong>
    </div>

    @if (!profileService.isEditable.privacy) {
    <div class="flex align-items-center justify-content-center gap-10px">
      <span>
        {{ profileService.profile.privacyId | privacyType }}
      </span>

      @if (!profileService.isEditable.privacy && profileService.isMyProfile) {
      <mat-icon
        class="pointer"
        (click)="profileService.preparePrivacyForm()"
        [class.disabled-icon]="
          profileService.isEditable.birthday ||
          profileService.isEditable.privacy
        "
        >edit</mat-icon
      >
      }
    </div>
    } @else { @if (profileService.isEditable.privacy &&
    profileService.isMyProfile) {
    <div
      class="flex justify-content-center align-items-center mt-10px gap-20px"
    >
      <app-select [field]="profileService.field"></app-select>
      <div class="close-icon">
        <mat-icon
          size="small"
          class="pointer"
          (click)="profileService.isEditable.privacy = false"
          >close</mat-icon
        >
      </div>
    </div>
    } }
  </div>

  @if (profileService.isMyProfile) {
  <div>
    <button
      class="w-125px mr-5px"
      mat-raised-button
      color="accent"
      (click)="saveProfile()"
      [disabled]="
        (!profileService.isEditable.birthday &&
          !profileService.isEditable.privacy) ||
        profileService.settingProfile
      "
    >
      @if (profileService.settingProfile && (!profileService.savingProfileImage
      || !profileService.deleteProfileImage)) {
      <mat-spinner class="h-25px w-25px"></mat-spinner>
      } @else {
      <span>Save Profile</span>
      }
    </button>

    <button
      class="ml-5px"
      mat-raised-button
      color="accent"
      (click)="signOutUser()"
      [disabled]="
        profileService.settingProfile || profileService.savingProfileImage
      "
    >
      Sign Out
    </button>

    <button
      class="ml-5px w-135px"
      mat-raised-button
      color="warn"
      (click)="openConfirmProfileDeletionDialog()"
      [disabled]="
        profileService.settingProfile ||
        profileService.savingProfileImage ||
        profileService.deletingProfile
      "
    >
      @if (profileService.deletingProfile) {
      <mat-spinner class="h-25px w-25px"></mat-spinner>
      } @else {
      <span>Delete Profile</span>
      }
    </button>
  </div>
  } }
</div>
